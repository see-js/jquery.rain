$(function(){"use strict";function WxRain(wrap,cfg){var config=$.extend(!0,{},cfg||{});this.wrap=wrap,this.get=function(n){return config[n]},this.set=function(n,v){config[n]=v},this.init()}Object.keys=Object.keys||function(obj){var keys=[];for(var key in obj)obj.hasOwnProperty(key)&&keys.push(key);return keys},Array.isArray=Array.isArray||function(arr){return"[object Array]"===Object.prototype.toString.call(arr)};var ICONS={star:"http://img13.360buyimg.com/cms/jfs/t3286/16/5426262213/2385/1930356e/5865c84cN32ebbcc8.png",cake:"http://img14.360buyimg.com/cms/jfs/t3943/283/1021426942/3625/f41ae0bf/5865c84cN3494e5b9.png",emoji:"http://img13.360buyimg.com/cms/jfs/t4051/304/1014272481/3653/a379e0a2/5865c84cN2e6defde.png",two:["star","cake"],three:["star","emoji","cake"]},ANIMS={rotate:"anim-rotate",rotateX:"anim-rotate-x",rotateY:"anim-rotate-y"},_DEFAULT={useIcon:"star",animate:"none",rainTime:10,autoStop:!0,duration:[1,4],scale:[.8,1.2]},BODY=$("body"),initSize=32;WxRain.prototype.init=function(){var that=this;this.createWrap(),this.bindWrap(),this.startRain(),this.get("autoStop")&&setTimeout(function(){that.stopRain()},1e3*this.get("rainTime")),this.set("count",0)},WxRain.prototype.createWrap=function(){var $wrap=$("<div>");return BODY.append($wrap),this.set("container",$wrap),$wrap},WxRain.prototype.bindWrap=function(){var wrap=this.wrap,offset=wrap.offset(),size={width:wrap.outerWidth(),height:wrap.outerHeight()},zIndex=wrap.css("zIndex")||0,cont=this.get("container");this.set("area",size),cont.css({position:"absolute",top:offset.top,left:offset.left,zIndex:zIndex+1,width:size.width,height:size.height,overflow:"hidden"})},WxRain.prototype.startRain=function(){var that=this,icon=ICONS[this.get("useIcon")]||ICONS.star,area=this.get("area"),anim=this.get("animate"),animClass="",animKeys=[],timer=this.get("timer"),cont=this.get("container"),scale=this.get("scale"),dur=this.get("duration"),interval=.3*dur[0];"auto"===anim?(animKeys=Object.keys(ANIMS),animClass=ANIMS[animKeys[Math.floor(Math.random()*animKeys.length)]]):animClass=ANIMS[anim]||"",timer&&clearInterval(timer),timer=setInterval(function(){for(var animer,count=Math.floor(2*Math.random())+2,i=0,iconSize=initSize,endPoint={top:0,left:0},duration=1e3,sc=1,imgUrl="";i<count;i++)iconSize=initSize*(scale[1]||2),endPoint={top:area.height+10,left:Math.random()*area.width},duration=parseInt(1e3*(Math.random()*(dur[1]-dur[0])+dur[0])),sc=(Math.random()*(scale[1]-scale[0])+scale[0]).toFixed(1),animer=$('<div class="rain-animer">'),animClass&&animer.addClass(animClass),imgUrl=Array.isArray(icon)?ICONS[icon[Math.floor(Math.random()*icon.length)]]||ICONS.star:icon,animer.html('<img src="'+imgUrl+'">').css({position:"absolute",top:"-"+iconSize+"px",left:Math.random()*area.width-iconSize,webkitTransform:"scale("+sc+")",transform:"scale("+sc+")"}).animate(endPoint,duration,"linear",function(){$(this).stop().remove(),that.set("count",that.get("count")-1),0===that.get("count")&&that.get("container").remove()}).appendTo(cont);that.set("count",that.get("count")+count)},1e3*interval),this.set("timer",timer)},WxRain.prototype.stopRain=function(){var timer=this.get("timer");timer&&(clearInterval(timer),timer=null)},$.fn.rain=function(cfg){var config=$.extend({},_DEFAULT,cfg||{});if(!this.length)throw"Elements not found.";return this.each(function(idx,ele){var $this=$(ele);$this.parents("body").length||($this=BODY),$this.data("rain",new WxRain($this,config))})}});